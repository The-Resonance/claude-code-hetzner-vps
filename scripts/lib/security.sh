#!/bin/sh
# security.sh - Security hardening and cloud-init generation
# POSIX-compatible
# A free tool by Pete Sena | labs.theresonance.studio

set -eu

# Generate cloud-init configuration with full security hardening
generate_cloud_init() {
    username="${1:-claude}"
    ssh_pub_key="$2"

    cat << CLOUD_INIT
#cloud-config
# claude-code-hetzner-vps security hardening
# Generated by The Resonance Labs
# https://labs.theresonance.studio

users:
  - name: ${username}
    groups: sudo
    shell: /bin/bash
    sudo: ALL=(ALL) NOPASSWD:ALL
    ssh_authorized_keys:
      - ${ssh_pub_key}

package_update: true
package_upgrade: true

packages:
  - ufw
  - fail2ban
  - unattended-upgrades
  - curl
  - git
  - htop
  - jq

write_files:
  # fail2ban SSH jail configuration
  - path: /etc/fail2ban/jail.local
    content: |
      [sshd]
      enabled = true
      port = ssh
      filter = sshd
      logpath = /var/log/auth.log
      maxretry = 5
      bantime = 3600
      findtime = 600

  # SSH hardening configuration
  - path: /etc/ssh/sshd_config.d/hardening.conf
    content: |
      PermitRootLogin no
      PasswordAuthentication no
      PubkeyAuthentication yes
      MaxAuthTries 3
      X11Forwarding no
      AllowAgentForwarding no
      AllowTcpForwarding no

  # MOTD branding
  - path: /etc/motd
    content: |

      ══════════════════════════════════════════════════════════════
        Server provisioned by claude-code-hetzner-vps

        A free tool by Pete Sena
        https://labs.theresonance.studio
        https://linkedin.com/in/petersena
      ══════════════════════════════════════════════════════════════

      Security features enabled:
        ✓ UFW firewall (port 22 only)
        ✓ fail2ban intrusion prevention
        ✓ SSH key-only authentication
        ✓ Root login disabled
        ✓ Automatic security updates

      Claude Code is ready. Run: claude

      ══════════════════════════════════════════════════════════════


runcmd:
  # Configure UFW firewall
  - ufw default deny incoming
  - ufw default allow outgoing
  - ufw allow 22/tcp
  - ufw --force enable

  # Enable and start fail2ban
  - systemctl enable fail2ban
  - systemctl start fail2ban

  # Enable automatic security updates
  - systemctl enable unattended-upgrades

  # Install Claude Code CLI for the claude user (official method)
  - su - ${username} -c "curl -fsSL https://claude.ai/install.sh | bash"
  - ln -sf /home/${username}/.claude/bin/claude /usr/local/bin/claude 2>/dev/null || true

  # Restart SSH to apply hardening
  - systemctl restart sshd

  # Log completion
  - echo "claude-code-hetzner-vps provisioning complete" > /var/log/claude-code-hetzner-vps.log
  - date >> /var/log/claude-code-hetzner-vps.log

final_message: |
  ══════════════════════════════════════════════════════════════
  claude-code-hetzner-vps provisioning complete!
  Server is secured and Claude Code is ready.
  ══════════════════════════════════════════════════════════════
CLOUD_INIT
}

# Print UFW rules summary
print_ufw_summary() {
    cat << 'EOF'
UFW Firewall Rules (Default):
  ✓ Deny all incoming traffic
  ✓ Allow all outgoing traffic
  ✓ Allow SSH (port 22/tcp)

To add web server ports:
  sudo ufw allow 80/tcp
  sudo ufw allow 443/tcp

To check status:
  sudo ufw status verbose
EOF
}

# Print fail2ban summary
print_fail2ban_summary() {
    cat << 'EOF'
fail2ban Configuration:
  ✓ SSH jail enabled
  ✓ Max retries: 5
  ✓ Ban time: 1 hour
  ✓ Find time: 10 minutes

To check status:
  sudo fail2ban-client status sshd

To unban an IP:
  sudo fail2ban-client set sshd unbanip <IP>
EOF
}

# Print SSH hardening summary
print_ssh_summary() {
    cat << 'EOF'
SSH Hardening:
  ✓ Root login disabled
  ✓ Password authentication disabled
  ✓ Public key authentication only
  ✓ Max authentication attempts: 3
  ✓ X11 forwarding disabled
  ✓ Agent/TCP forwarding disabled
EOF
}
